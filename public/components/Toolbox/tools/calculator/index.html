<!DOCTYPE html>
<html lang="zh-Hans">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>多行简单计算器</title>
    <!-- Font Awesome for icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      /* 基础样式 */
      html,
      body {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        background-color: #f0f0f0;
        font-family: sans-serif;
        overflow-x: hidden;
        position: relative;
      }

      /* 暗黑模式支持 */
      body.dark-mode {
        background-color: #333;
        color: #eee;
      }
      body.dark-mode .calculator-container {
        background-color: #222;
      }
      body.dark-mode .display {
        background-color: #1a1a1a;
        color: #fff;
      }
      body.dark-mode .keypad button {
        background-color: #3a3a3a;
        color: #fff;
      }
      body.dark-mode .keypad button.operator {
        background-color: #ff9500;
      }
      body.dark-mode .keypad button:active {
        background-color: #555;
      }
      body.dark-mode .keypad button.operator:active {
        background-color: #ffb54d;
      }

      /* 主容器 */
      .calculator-container {
        width: 100%;
        max-width: 320px;
        margin: 1rem auto;
        background-color: #24273d;
        border-radius: 1rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        padding: 1rem;
      }

      /* 显示区域 */
      .display {
        width: 100%;
        height: 200px;
        background-color: #151729;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
        padding: 1rem;
        box-sizing: border-box;
        overflow-y: auto;
        color: white;
        font-family: monospace;
        font-size: 18px;
        display: flex;
        flex-direction: column;
        text-align: right;
      }

      .calculation-line {
        display: flex;
        justify-content: space-between;
        margin: 5px 0;
      }

      .calculation {
        color: #ccc;
      }

      .result {
        font-weight: bold;
        color: white;
      }

      /* 键盘区域 */
      .keypad {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        grid-gap: 10px;
      }

      .keypad button {
        width: 100%;
        height: 60px;
        border-radius: 50%;
        border: none;
        background-color: #505050;
        color: white;
        font-size: 20px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.1s;
        user-select: none;
      }

      .keypad button:active {
        transform: scale(0.95);
        background-color: #606060;
      }

      .keypad button.operator {
        background-color: #ff9500;
        color: white;
      }

      .keypad button.operator:active {
        background-color: #ffb54d;
      }

      /* 页面标题 */
      h1 {
        color: #444;
        margin-top: 1rem;
        font-size: 1.5rem;
        text-align: center;
      }

      /* 描述文本 */
      .description {
        color: #666;
        margin: 0.5rem 1rem 1.5rem;
        font-size: 0.9rem;
        text-align: center;
        max-width: 600px;
      }

      /* 暗黑模式下标题和描述 */
      body.dark-mode h1 {
        color: #eee;
      }
      body.dark-mode .description {
        color: #ccc;
      }

      /* 当前行高亮 */
      .calculation-line.current {
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
        padding: 4px 5px;
        min-height: 24px; /* 确保即使没有内容也有最小高度 */
      }

      /* 上下切换行按钮 */
      .keypad button.nav-button {
        background-color: #3e3e3e;
      }

      .keypad button.nav-button:active {
        background-color: #555;
      }
    </style>
  </head>
  <body>
    <p class="description">
      无需按等号，实时计算结果。点击计算结果作为最后一行新计算行的起始值
    </p>

    <div class="calculator-container">
      <div class="display" id="display">
        <!-- 计算结果将显示在这里 -->
      </div>

      <div class="keypad">
        <button class="back" id="backspace">
          <i class="fas fa-backspace"></i>
        </button>
        <button class="nav-button" id="up-button">
          <i class="fas fa-chevron-up"></i>
        </button>
        <button class="nav-button" id="down-button">
          <i class="fas fa-chevron-down"></i>
        </button>
        <button id="new-line">
          <i class="fas fa-level-down-alt fa-rotate-90"></i>
        </button>

        <button id="btn7">7</button>
        <button id="btn8">8</button>
        <button id="btn9">9</button>
        <button class="operator" id="divide">÷</button>

        <button id="btn4">4</button>
        <button id="btn5">5</button>
        <button id="btn6">6</button>
        <button class="operator" id="multiply">×</button>

        <button id="btn1">1</button>
        <button id="btn2">2</button>
        <button id="btn3">3</button>
        <button class="operator" id="subtract">-</button>

        <button id="btn0">0</button>
        <button id="decimal">.</button>
        <button class="operator" id="percent">%</button>
        <button class="operator" id="add">+</button>
      </div>
    </div>

    <script>
      // 主要变量
      let currentCalculation = "";
      let calculations = [];
      const display = document.getElementById("display");
      let currentLineIndex = -1; // 当前所在行索引，-1表示最新行

      // 检测暗黑模式
      function checkDarkMode() {
        try {
          if (window.parent.document.body.classList.contains("dark-mode")) {
            document.body.classList.add("dark-mode");
          }
        } catch (e) {
          console.log("无法检测父窗口的暗黑模式状态");
        }
      }

      // 添加新的计算行
      function addCalculationLine() {
        if (currentCalculation.trim() === "") {
          return; // 如果是空白输入，不添加新行
        }

        try {
          // 替换乘除符号为JavaScript可识别的
          let evalString = currentCalculation
            .replace(/×/g, "*")
            .replace(/÷/g, "/")
            .replace(/%/g, "/100");

          // 计算结果
          const result = eval(evalString);

          // 创建新的计算行
          const calculationLine = document.createElement("div");
          calculationLine.className = "calculation-line";

          // 计算表达式
          const calculationSpan = document.createElement("span");
          calculationSpan.className = "calculation";
          calculationSpan.textContent = currentCalculation;

          // 计算结果
          const resultSpan = document.createElement("span");
          resultSpan.className = "result";
          resultSpan.textContent = result;

          // 将表达式和结果添加到计算行
          calculationLine.appendChild(calculationSpan);
          calculationLine.appendChild(resultSpan);

          // 将计算行添加到显示区域
          display.appendChild(calculationLine);

          // 保存计算记录
          calculations.push({
            calculation: currentCalculation,
            result: result,
          });

          // 清空当前计算
          currentCalculation = "";

          // 滚动到底部
          display.scrollTop = display.scrollHeight;
        } catch (error) {
          // 处理计算错误
          const errorLine = document.createElement("div");
          errorLine.className = "calculation-line";

          const errorCalc = document.createElement("span");
          errorCalc.className = "calculation";
          errorCalc.textContent = currentCalculation;

          const errorResult = document.createElement("span");
          errorResult.className = "result";
          errorResult.style.color = "#ff5252";
          errorResult.textContent = "错误";

          errorLine.appendChild(errorCalc);
          errorLine.appendChild(errorResult);
          display.appendChild(errorLine);

          currentCalculation = "";
          display.scrollTop = display.scrollHeight;
        }
      }

      // 更新显示
      function updateDisplay() {
        // 移除旧的当前行
        const oldCurrentLine = document.getElementById("current-line");
        if (oldCurrentLine) {
          display.removeChild(oldCurrentLine);
        }

        // 创建新的计算行
        const currentLine = document.createElement("div");
        currentLine.className = "calculation-line current"; // 添加current类以高亮显示
        currentLine.id = "current-line";

        const currentCalc = document.createElement("span");
        currentCalc.className = "calculation";
        // 即使是空字符串也显示为空格，确保占位
        currentCalc.textContent = currentCalculation || " ";

        const currentResult = document.createElement("span");
        currentResult.className = "result";

        try {
          if (currentCalculation) {
            let evalString = currentCalculation
              .replace(/×/g, "*")
              .replace(/÷/g, "/")
              .replace(/%/g, "/100");
            currentResult.textContent = eval(evalString);
          } else {
            // 确保空计算也有占位符
            currentResult.textContent = " ";
          }
        } catch (e) {
          currentResult.textContent = " ";
        }

        currentLine.appendChild(currentCalc);
        currentLine.appendChild(currentResult);

        // 添加新的当前行
        display.appendChild(currentLine);
        display.scrollTop = display.scrollHeight;
      }

      // 按钮点击处理
      function handleButtonClick(value) {
        switch (value) {
          case "⌫":
            // 删除最后一个字符
            currentCalculation = currentCalculation.slice(0, -1);

            // 如果删除后内容为空且有历史行，则自动跳转到上一行
            if (currentCalculation === "") {
              const allLines = display.querySelectorAll(
                ".calculation-line:not(#current-line)"
              );
              if (allLines.length > 0) {
                // 如果当前不是在浏览历史记录，则跳到最后一行历史
                if (currentLineIndex === -1) {
                  // 跳转到上一行但不复制内容
                  goToPreviousLine(false);
                  return; // 不需要继续更新显示
                }
              }
            }
            break;
          case "↵":
            // 保存当前计算（如果有）
            if (currentCalculation) {
              addCalculationLine();
            }
            // 无条件清空当前计算内容
            currentCalculation = "";
            break;
          default:
            currentCalculation += value;
            break;
        }

        // 始终更新显示，但保持在当前行
        updateDisplay();
      }

      // 添加新函数 - 切换到上一行
      function goToPreviousLine(shouldCopyContent = true) {
        // 获取所有计算行
        const allLines = display.querySelectorAll(
          ".calculation-line:not(#current-line)"
        );

        // 如果没有历史记录，无法切换
        if (allLines.length === 0) return;

        // 计算要跳转的行索引
        if (currentLineIndex === -1) {
          // 如果当前在最新行，则跳转到最后一条历史记录
          currentLineIndex = allLines.length - 1;
        } else if (currentLineIndex > 0) {
          // 上移一行
          currentLineIndex--;
        }

        // 获取目标行
        const targetLine = allLines[currentLineIndex];
        if (targetLine) {
          // 清除所有行的高亮
          allLines.forEach((line) => line.classList.remove("current"));

          if (shouldCopyContent) {
            // 获取该行的计算内容
            const calculation =
              targetLine.querySelector(".calculation").textContent;

            // 设置为当前计算
            currentCalculation = calculation;

            // 更新显示
            updateDisplay();
          } else {
            // 直接跳转到目标行，不复制内容
            // 设置为空计算
            currentCalculation = "";
            updateDisplay();
          }

          // 高亮显示当前历史行
          targetLine.classList.add("current");

          // 确保可见
          targetLine.scrollIntoView({ behavior: "smooth", block: "nearest" });
        }
      }

      // 添加新函数 - 切换到下一行
      function goToNextLine() {
        // 获取所有计算行
        const allLines = display.querySelectorAll(
          ".calculation-line:not(#current-line)"
        );

        // 如果没有历史记录或已经在最新行，无法下移
        if (allLines.length === 0 || currentLineIndex === -1) return;

        // 计算要跳转的行索引
        if (currentLineIndex < allLines.length - 1) {
          // 下移一行
          currentLineIndex++;

          // 获取目标行
          const targetLine = allLines[currentLineIndex];
          if (targetLine) {
            // 获取该行的计算内容
            const calculation =
              targetLine.querySelector(".calculation").textContent;

            // 设置为当前计算
            currentCalculation = calculation;

            // 清除所有行的高亮
            allLines.forEach((line) => line.classList.remove("current"));

            // 更新显示
            updateDisplay();

            // 高亮显示当前历史行
            targetLine.classList.add("current");

            // 确保可见
            targetLine.scrollIntoView({ behavior: "smooth", block: "nearest" });
          }
        } else {
          // 如果已经是最后一行历史记录，则跳转到新行
          currentLineIndex = -1;
          currentCalculation = "";

          // 清除所有行的高亮
          allLines.forEach((line) => line.classList.remove("current"));

          // 更新显示
          updateDisplay();
        }
      }

      // 设置按钮点击事件
      document.querySelectorAll(".keypad button").forEach((button) => {
        button.addEventListener("click", () => {
          let value;

          // 获取按钮值
          switch (button.id) {
            case "backspace":
              value = "⌫";
              break;
            case "add":
              value = "+";
              break;
            case "subtract":
              value = "-";
              break;
            case "multiply":
              value = "×";
              break;
            case "divide":
              value = "÷";
              break;
            case "decimal":
              value = ".";
              break;
            case "percent":
              value = "%";
              break;
            case "new-line":
              value = "↵";
              break;
            case "up-button":
              // 处理上移按钮 - 复制内容
              goToPreviousLine(true);
              return; // 不再继续处理
            case "down-button":
              // 处理下移按钮
              goToNextLine();
              return; // 不再继续处理
            default:
              // 数字按钮
              if (button.id.startsWith("btn")) {
                value = button.id.replace("btn", "");
              } else {
                value = button.textContent;
              }
          }

          handleButtonClick(value);
        });
      });

      // 设置键盘事件
      document.addEventListener("keydown", (event) => {
        let key = event.key;

        // 防止页面滚动
        if (
          ["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight", " "].indexOf(
            key
          ) > -1
        ) {
          event.preventDefault();
        }

        switch (key) {
          case "0":
          case "1":
          case "2":
          case "3":
          case "4":
          case "5":
          case "6":
          case "7":
          case "8":
          case "9":
          case ".":
          case "+":
          case "-":
            handleButtonClick(key);
            break;
          case "*":
            handleButtonClick("×");
            break;
          case "/":
            handleButtonClick("÷");
            break;
          case "%":
            handleButtonClick("%");
            break;
          case "Enter":
            handleButtonClick("↵");
            break;
          case "Backspace":
            handleButtonClick("⌫");
            break;
          case "ArrowUp":
            goToPreviousLine(true);
            break;
          case "ArrowDown":
            goToNextLine();
            break;
        }
      });

      // 点击结果可以复用之前的结果
      display.addEventListener("click", (event) => {
        if (event.target.className === "result") {
          const result = event.target.textContent;
          if (!isNaN(result) && result !== "") {
            // 确保当前是在最新行
            const allLines = display.querySelectorAll(
              ".calculation-line:not(#current-line)"
            );
            allLines.forEach((line) => line.classList.remove("current"));

            // 重置为最新行
            currentLineIndex = -1;

            // 如果当前有计算内容，先完成当前计算
            if (currentCalculation) {
              addCalculationLine();
            }

            // 将结果添加到新一行
            currentCalculation = result;
            updateDisplay();
          }
        }
      });

      // 初始化
      checkDarkMode();
      updateDisplay();
    </script>
  </body>
</html>
